&emsp;&emsp;理想情况下，每个时钟周期都有一条指令流入流水线，并且指令装入完成后，每个时钟周期都有一条执行完成的指令从流水线中流出。实际情况下，指令之间可能存在依赖关系，导致指令流中的指令不能在期望的时钟周期进入流水线执行。



## 1. 指令相关

&emsp;&emsp;相关（Dependence）指的是指令之间存在的依赖关系。当两条指令之间存在相关关系时，它们就不能在流水线中重叠执行，或只能部分重叠执行。

&emsp;&emsp;指令之间的相关关系包括数据相关、名相关和控制相关三种。

- **数据相关**

&emsp;&emsp;数据相关又称真数据相关，指的是指令之间存在数据依赖关系。比如指令流中，指令I~k+1~需要使用上一条指令I~k~的执行结果。

- **名相关**

&emsp;&emsp;名相关指的是存在多条指令同时使用了同一个寄存器或存储单元，但这些指令之间不存在数据相关。

&emsp;&emsp;名相关包括<u>反相关</u>和<u>输出相关</u>两种。反相关指的是指令I~k+1~的目标寄存器与指令流中的上一条指令I~k~的源寄存器相同；输出相关则指的是指令I~k+1~和指令I~k~的目标寄存器相同。

&emsp;&emsp;名相关可通过寄存器重命名（Register Renaming）解决。寄存器重命名既可以使用编译器或汇编器静态实现，也可以使用硬件动态实现。

- **控制相关**

&emsp;&emsp;控制相关指的是分支指令引起的指令相关 —— 在指令流中，排在分支指之后的指令是否执行，取决于分支指令的执行结果。



## 2. 流水线冒险

&emsp;&emsp;冒险（Hazard）指的是因为指令存在相关性而引起的流水线工作异常的现象。流水线出现冒险时，本来应该流入流水线的指令不能正常流入，使得指令之间的重叠执行程度降低，从而造成流水线性能的浪费。

&emsp;&emsp;流水线冒险包括结构冒险、数据冒险和控制冒险三种。

### 2.1 结构冒险

&emsp;&emsp;当流水线的硬件资源满足不了指令重叠执行的需求时，指令无法在期望的时钟周期内完成执行。此种情形称为流水线的结构冒险。

!!! example "举栗说明 :chestnut:"
    &emsp;&emsp;假设某流水线处理器只有一个指令和数据共享的存储器，则访存阶段和取指阶段将同时访问存储器。若该存储器只有一个访问端口，则流水线将发生结构冒险，如图3-1所示。

    <center><img src = "../assets/3-1.png" width = 600></center>
    <center>图3-1 结构冒险示例</center>

    &emsp;&emsp;由单存储器引起的结构冒险可通过哈佛结构解决 —— 分别设置独立的指令存储器和数据存储器。

&emsp;&emsp;结构冒险会造成流水线停顿，从而影响其性能。如果结构冒险出现的频次较高，则可以通过增加硬件资源的方式解决；否则可以忽视之，从而降低成本。

### 2.2 数据冒险

&emsp;&emsp;存在数据相关的指令同时在流水线中执行时，重叠执行可能会破坏指令之间的数据依赖关系，从而导致指令执行结果出错。此种情形称为流水线的数据冒险。

&emsp;&emsp;数据冒险包括写后读（RAW）、读后写（WAR）、写后写（WAW）三种类型。

- **RAW** 冒险

&emsp;&emsp;指令I~k+1~需要使用前一条指令I~k~的计算结果。当这两条指令在流水线中重叠执行时，若指令I~k+1~在指令I~k~将计算结果写回目标寄存器之前取操作数，则将取出错误的操作数，从而导致指令执行结果错误。此类型的数据冒险对应于指令的真数据相关。

- **WAR** 冒险

&emsp;&emsp;指令I~k+1~的目标寄存器与前一条指令I~k~的源寄存器相同。当这两条指令在流水线中重叠执行时，若指令I~k+1~在指令I~k~读取源操作数之前完成了写回操作，则指令I~k~将取出修改过的源操作数，从而导致指令执行结果错误。此类型的数据冒险对应于指令的名相关中的反相关。

- **WAW** 冒险

&emsp;&emsp;指令I~k+1~与前一条指令I~k~拥有相同的目标寄存器。当这两条指令在流水线中重叠执行时，若指令I~k+1~在指令I~k~写回之前写回，则目标寄存器最终的值将出现错误。此类型的数据冒险对应于指令的名相关中的输出相关。

!!! question "思考题 :triangular_ruler:"
    &emsp;&emsp;RISC经典五级流水“IF-ID-EX-MEM-WB”是否存在WAR和WAW的数据冒险？为什么？

&emsp;&emsp;数据冒险可通过<a href="../4-handleDH/#21" target="_blank">流水线暂停</a>、<a href="../4-handleDH/#22" target="_blank">数据前递</a>和<a href="../4-handleDH/#23" target="_blank">乱序执行</a>等技术解决。

### 2.3 控制冒险

&emsp;&emsp;指令出现控制相关时，若分支指令尚未执行完成，则无法确定接下来需要执行哪条指令，从而出现流水线进入停顿状态的现象。此种情形称为流水线的控制冒险。

!!! example "举栗说明 :chestnut:"
    &emsp;&emsp;在流水线处理器中，分支指令完成执行阶段之前，无法确定下一条应该执行什么指令，如图3-2所示。

    <center><img src = "../assets/3-2.png" width = 600></center>
    <center>图3-2 控制冒险示意图</center>

&emsp;&emsp;控制冒险可通过<a href="../4-handleDH/#21" target="_blank">流水线暂停</a>或引入<a href="../5-handleCH/" target="_blank">分支预测</a>机制等方法解决。
