&emsp;&emsp;理想流水线一般指流水线中不存在冲突或冒险（Hazzard）问题、不存在资源冲突，且进入流水线的指令相互之间不存在依赖关系或相关关系。



## **·** 单周期数据通路改造

&emsp;&emsp;通过修改单周期CPU的数据通路，可以实现简易流水线CPU的设计。

&emsp;&emsp;以下以图2-1所示的单周期CPU为例，介绍如何将单周期CPU改造成“取指-译码-执行”的三级理想流水CPU。

<center><img src = "../assets/2-1.png" width = 550></center>
<center>图2-1 单周期CPU数据通路示例</center>

&emsp;&emsp;第一步，根据目标流水线的阶段构成，分割单周期CPU的数据通路，并在分割处加入流水线段寄存器，将各阶段之间的接口信号缓存起来，如图2-2所示。

<center><img src = "../assets/2-2.png" width = 550></center>
<center>图2-2 分割单周期CPU数据通路</center>

&emsp;&emsp;第二步，根据需要修改PC逻辑，确保流水线能够正常“流动”起来。观察如图2-2所示的数据通路，不难发现，复位后PC寄存器无法正常完成“PC+4”的操作。为此，需要将图2-2中“PC+4”操作的相关逻辑前移到取指阶段，如图2-3所示。

<center><img src = "../assets/2-3.png" width = 550></center>
<center>图2-3 前移“PC+4”逻辑</center>

&emsp;&emsp;第三步，修改写回逻辑，确保指令的执行结果能够写回到正确的寄存器。将原有的单周期数据通路“切割”成三个流水级之后，每个流水级都有一条指令在执行。不妨假设在某个时刻，指令I~0~、I~1~、I~2~分别出于执行阶段、译码阶段和取指阶段。当执行阶段的指令I~0~需要写回时，寄存器堆的写使能信号、目标寄存器号和写数据信号都是由指令I~1~译码产生的。此时，若进行写回操作，则将发生指令I~0~的执行结果写回到指令I~1~的目标寄存器的错误。为了避免此错误发生，需要在指令I~0~从译码阶段进入到执行阶段时，将其写回的相关信号通过段寄存器传递到执行阶段，如图2-4所示。

<center><img src = "../assets/2-4.png" width = 550></center>
<center>图2-4 修改写回逻辑</center>
